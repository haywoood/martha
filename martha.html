<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>{Title}{block:PostTitle}: {PostTitle}{/block:PostTitle}</title>
    {block:Description}
    <meta name="description" content="{MetaDescription}">
    {/block:Description}
    <meta name="viewport" content="width=device-width">

    <!-- Tumblr Theme configuration -->
    <meta name="text:URL" content="" />
    <meta name="text:Tumblr API key" content="" />
    <!-- END Tumblr Theme configuration -->

    <link rel="shortcut icon" href="{Favicon}">
    <link rel="apple-touch-icon" href="{PortraitURL-128}">
    <link rel="alternate" type="application/rss+xml" href="{RSS}">

    <link rel="stylesheet" href="https://raw.github.com/wxrod/Tumblr-HTML5-Blank-Theme/master/css/normalize.min.css">
  </head>
  <body>
  
    <!-- Mount node -->
    <div class="site"></div>
    
    <!-- Can't live without these -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react-with-addons.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/ramda/ramda/master/dist/ramda.min.js" type="text/javascript"></script>

    <!-- The Template -->
    <script>
        "use strict";
        
        var d = React.DOM;
        
        // App components
            
        var Header = React.createClass({
            render: function() {
                var title = this.props.title;
                return d.h1(null, title);
            }
        });
        
        function buildAll(component, list) {
            return R.map(function(x) {
                return c(component, x)
            }, list)
        }
        
        function makeNavCategory(category) {
            var name = category[0];
            var items = category[1];
            return (
                c("li", null, [
                    c("div", {className: "nav-item-" + name}, name),
                    c("ul", null, buildAll(NavItem, items))
                ])
            );
        }
                
        var NavItem = React.createClass({
           render: function() {
               return d.li(null, this.props.title);
           } 
        });
        
        var Navigation = React.createClass({
            render: function() {
                var categories = this.props.categories;
                return d.div(null, R.map(makeNavCategory, categories));
            }
        })
        
        // Das rooot
        
        var App = React.createClass({
            getInitialState: function() {
                return {
                    blog: null,
                    categories: []
                }    
            },
            
            componentWillMount: function() {
                var self = this;
                return this.props.ajax.getPosts()
                .then(function(results) {
                    return self.setState({
                        blog: results.blog,
                        categories: getCategories(results.posts)
                    });
                });
            },
            
            render: function() {
                var blog = this.state.blog;
                
                if (!blog) {
                    return c("div", null, "loading");
                }
                
                var categories = { categories: this.state.categories };
                return wrap([
                    c(Header, blog),
                    c(Navigation, categories)
                ]);
            } 
        });
        
        // Our Apps entry point
        // injecting the ajax and api key because... meh, might want to swap it out later
        
        var main = function(ajax, apiKey) {
            var url = "{text:URL}";
            var ajax = new Ajax(ajax, url, apiKey);
            var mountNode = document.getElementsByClassName('site')[0];
            render(mountNode, App, {ajax: ajax});
        }
        
        // Listen for page load and init the app
        
        var apiKey = "{text:Tumblr API key}";
        document.addEventListener("DOMContentLoaded", main.bind(null, $.ajax, apiKey));
        
        // React convience functions
        
        function wrap(opts, children) {
            if (arguments.length === 1) {
                children = opts;
                opts = null;
            }
            return c("div", opts, children)
        }
        
        function c(klass, props, children) {
            return React.createElement(klass, props, children);
        }
        
        function render(mountNode, component, state) {
            React.render(c(component, state), mountNode);
            return true;
        }
        
        // Data munging funcitons
        function addPostToCategory(post) {
            return function(obj, cat) {
                var newObj = R.merge(obj, {});
                if (!newObj[cat]) {
                    newObj[cat] = [post];
                    return newObj;
                } else {
                    newObj[cat].concat([post]);
                    return newObj;
                }
            }
        }
        
        function categoriesFromTags(acc, tag) {
            var category = null;
            var match = tag.match("category");
            if (match) {
                category = R.last(tag.split(":"));
                return acc.concat([category]);
            } else {
                return acc
            }
        }
        
        function getCategory(acc, post) {
            var tags = post.tags;
            var categories = R.reduce(categoriesFromTags, [], tags);
            if (!R.isEmpty(categories)) {
                return R.reduce(addPostToCategory(post), acc, categories);
            } else {
                return acc
            }
        }
        
        var getCategories = R.compose(R.toPairs, R.reduce(getCategory, {}));
        
        // Ajax helper class
        
        function Ajax(request, hostname, key) {
            this.__request = request;
            this.__hostname = hostname;
            this.__key = key;
        }
        
        Ajax.prototype.request = function(method, url, data) {
            return this.__request({
                url: url,
                type: method,
                data: data,
                dataType: "jsonp"
            });
        }
        
        Ajax.prototype.getPosts = function() {
            var url = "http://api.tumblr.com/v2/blog/" + this.__hostname + ".tumblr.com/posts?api_key=" + this.__key;
            return this.request("get", url, {})
            .then(function(res) {
                return res.response;
            });
        }
    </script>
  </body>
</html>
